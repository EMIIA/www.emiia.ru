<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивная диаграмма роста</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.3/dist/panzoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }
        
        body {
            background: white;
            height: 100vh;
            overflow: hidden;
            padding: 10px;
        }
        
        .diagram-wrapper {
            position: relative;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            height: calc(100vh - 20px);
            width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        #diagram {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transform-origin: center center;
            transition: transform 0.2s ease;
            background: white;
        }
        
        .mermaid {
            font-family: 'Montserrat', sans-serif;
            padding: 40px;
        }
        
        .node rect, .node circle, .node polygon {
            border-radius: 16px !important;
            stroke-width: 2px !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        /* Контролы на диаграмме */
        .controls-overlay {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }
        
        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(78, 115, 223, 0.92);
            color: white;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .control-btn:hover {
            background: #2e59d9;
            transform: scale(1.08);
        }
        
        .control-btn:active {
            transform: scale(0.96);
        }
        
        .download-btn {
            background: rgba(54, 185, 204, 0.92);
        }
        
        .download-btn:hover {
            background: #2c9faf;
        }
        
        .reset-btn {
            background: rgba(133, 135, 150, 0.92);
        }
        
        .reset-btn:hover {
            background: #6c6e7e;
        }
        
        /* Выпадающее меню загрузки */
        .download-menu {
            position: absolute;
            top: 60px;
            right: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            padding: 12px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 200;
            min-width: 160px;
            transform-origin: top right;
            animation: fadeIn 0.25s ease;
            border: 1px solid #f0f0f0;
        }
        
        .download-menu.active {
            display: flex;
        }
        
        .download-option {
            background: #f8f9fa;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            color: #2c3e50;
            font-size: 0.9rem;
        }
        
        .download-option:hover {
            background: #4e73df;
            color: white;
        }
        
        .scale-display {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.92);
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #2c3e50;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 100;
            border: 1px solid #f0f0f0;
        }
        
        .hint {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.92);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #5a67d8;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 100;
            border: 1px solid #f0f0f0;
            font-weight: 500;
        }
        
        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .download-menu {
                top: 55px;
                min-width: 150px;
                padding: 10px;
            }
            
            .download-option {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .hint {
                font-size: 0.75rem;
                max-width: 140px;
                text-align: right;
            }
        }
        
        @media (max-width: 480px) {
            .diagram-wrapper {
                height: calc(100vh - 15px);
            }
            
            .control-btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            
            .download-menu {
                top: 50px;
                right: 10px;
            }
            
            .scale-display, .hint {
                font-size: 0.75rem;
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="diagram-wrapper">
        <div id="diagram" class="mermaid">
graph TD
    A(Текущее состояние • ARPU $36<br>• 30 млн платящих) --> B{Этап 1:<br>Горизонтальный рост}
    B --> C(Увеличение платящих до 80 млн<br>• ARPU $36 = $28.8 млрд)
    A --> D{Этап 2:<br>Вертикальный рост}
    D --> E(Запуск премиум-сегмента<br>• 20 млн пользователей<br>• ARPU $720 = $14.4 млрд)
    C --> F(Суммарно:<br>$28.8 + $14.4 = $43.2 млрд)
    F --> G{Этап 3:<br>Экосистема}
    G --> H(B2B-решения<br>• Комиссии<br>• Данные = $72 млрд)
        </div>
        
        <!-- Элементы управления поверх диаграммы -->
        <div class="controls-overlay">
            <button class="control-btn download-btn" id="download-toggle">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
            </button>
            
            <button class="control-btn" id="zoom-in">
                <svg width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
            </button>
            
            <button class="control-btn" id="zoom-out">
                <svg width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
                </svg>
            </button>
            
            <button class="control-btn reset-btn" id="reset-zoom">
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
            </button>
        </div>
        
        <!-- Выпадающее меню загрузки -->
        <div class="download-menu" id="download-menu">
            <button class="download-option" id="download-png">
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                </svg>
                PNG
            </button>
            <button class="download-option" id="download-svg">
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 0h16v16H0V0z" fill="none"/>
                    <path d="M8 13.5l-5-5 1-1 3 3 3-3 1 1-5 5zm0-12L3 7l1 1 3-3 3 3 1-1-5-5z"/>
                </svg>
                SVG
            </button>
            <button class="download-option" id="download-code">
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8l3.147-3.146zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8l-3.147-3.146z"/>
                </svg>
                Код
            </button>
        </div>
        
        <div class="scale-display" id="scale-display">Масштаб: 100%</div>
        <div class="hint" id="hint">Используйте колесо мыши для масштабирования</div>
    </div>

    <script>
        // Инициализация Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                nodeSpacing: 50,
                rankSpacing: 70
            },
            securityLevel: 'loose',
            fontFamily: "'Montserrat', sans-serif"
        });
        
        // Переменные
        let scale = 1;
        const diagram = document.getElementById('diagram');
        const scaleDisplay = document.getElementById('scale-display');
        const downloadMenu = document.getElementById('download-menu');
        const downloadToggle = document.getElementById('download-toggle');
        const hintElement = document.getElementById('hint');
        const zoomStep = 0.1;
        const minScale = 0.3;
        const maxScale = 3;
        
        // Инициализация Panzoom
        const panzoomController = panzoom(diagram, {
            bounds: true,
            boundsPadding: 0.8,
            minZoom: minScale,
            maxZoom: maxScale,
            smoothScroll: false,
            beforeWheel: function(e) {
                return true;
            }
        });
        
        // Обновление отображения масштаба
        function updateScaleDisplay() {
            scale = panzoomController.getTransform().scale;
            scaleDisplay.textContent = `Масштаб: ${Math.round(scale * 100)}%`;
        }
        
        // Обработчики событий для кнопок
        document.getElementById('zoom-in').addEventListener('click', () => {
            panzoomController.smoothZoom(diagram.clientWidth/2, diagram.clientHeight/2, 1 + zoomStep);
            setTimeout(updateScaleDisplay, 100);
        });
        
        document.getElementById('zoom-out').addEventListener('click', () => {
            panzoomController.smoothZoom(diagram.clientWidth/2, diagram.clientHeight/2, 1 - zoomStep);
            setTimeout(updateScaleDisplay, 100);
        });
        
        document.getElementById('reset-zoom').addEventListener('click', () => {
            panzoomController.moveTo(0, 0);
            panzoomController.zoomAbs(0, 0, 1);
            setTimeout(updateScaleDisplay, 100);
        });
        
        // Переключение меню загрузки
        downloadToggle.addEventListener('click', (e) => {
            downloadMenu.classList.toggle('active');
            e.stopPropagation();
        });
        
        // Закрытие меню при клике в другом месте
        document.addEventListener('click', (e) => {
            if (!downloadMenu.contains(e.target) && e.target !== downloadToggle) {
                downloadMenu.classList.remove('active');
            }
        });
        
        // Функции скачивания
        document.getElementById('download-png').addEventListener('click', async () => {
            try {
                downloadMenu.classList.remove('active');
                
                const originalTransform = diagram.style.transform;
                diagram.style.transform = 'none';
                
                await new Promise(resolve => setTimeout(resolve, 50));
                
                const canvas = await html2canvas(diagram, {
                    backgroundColor: '#ffffff',
                    scale: 3,
                    logging: false
                });
                
                diagram.style.transform = originalTransform;
                
                canvas.toBlob(blob => {
                    saveAs(blob, 'growth-plan.png');
                });
            } catch (error) {
                alert('Ошибка при создании PNG: ' + error.message);
            }
        });
        
        document.getElementById('download-svg').addEventListener('click', () => {
            try {
                downloadMenu.classList.remove('active');
                const svgElement = diagram.querySelector('svg');
                
                if (!svgElement) {
                    throw new Error('SVG элемент не найден');
                }
                
                const svgData = new XMLSerializer().serializeToString(svgElement);
                const blob = new Blob([svgData], {type: 'image/svg+xml'});
                saveAs(blob, 'growth-plan.svg');
            } catch (error) {
                alert('Ошибка при создании SVG: ' + error.message);
            }
        });
        
        document.getElementById('download-code').addEventListener('click', () => {
            try {
                downloadMenu.classList.remove('active');
                const code = `graph TD
    A[Текущее состояние • ARPU $36<br>• 30 млн платящих] --> B{Этап 1: Горизонтальный рост}
    B --> C(Увеличение платящих до 80 млн • ARPU $36 = $28.8 млрд)
    A --> D{Этап 2: Вертикальный рост}
    D --> E(Запуск премиум-сегмента • 20 млн пользователей • ARPU $720 = $14.4 млрд)
    C --> F[Суммарно: $28.8 + $14.4 = $43.2 млрд]
    F --> G{Этап 3: Экосистема}
    G --> H(B2B-решения • Комиссии • Данные = $72 млрд)`;
                
                const blob = new Blob([code], {type: 'text/plain'});
                saveAs(blob, 'growth-plan.mmd');
            } catch (error) {
                alert('Ошибка при скачивании кода: ' + error.message);
            }
        });
        
        // Обновление масштаба при изменениях
        panzoomController.on('zoom', updateScaleDisplay);
        panzoomController.on('pan', updateScaleDisplay);
        
        // Инициализация отображения масштаба
        updateScaleDisplay();
        
        // Адаптация под мобильные устройства
        window.addEventListener('resize', () => {
            if (window.innerWidth < 768 && scale > 1.5) {
                panzoomController.zoomAbs(0, 0, 1);
                panzoomController.moveTo(0, 0);
                updateScaleDisplay();
            }
        });
        
        // Подсказка для мобильных устройств
        if ('ontouchstart' in window) {
            hintElement.innerHTML = 'Используйте два пальца для масштабирования<br>Перетаскивайте для перемещения';
        }
    </script>
</body>
</html>
